// Workdir for temporary data
projectName = 'TO_BE_SET'
date = new Date().format( 'yyyyMMdd-HHmmss')
//workDir = "$SCRATCH/wf/$date-$projectName"
workDir = "$SCRATCH/wf/$projectName"

// Git informations of workflow
manifest {
    homePage = 'https://gitlab.ifremer.fr/bioinfo/nextmb'
    description = 'Workflow for NGS metabarcoding data analysis used by Ifremer/SeBiMer team'
    defaultBranch = 'master'
    author = 'Cyril NoÃ«l, Laure Quintric'
    mainScript = 'MB.nf'
    name = 'SeBiMer-MB-Workflow'
}

// Define env variable that will be accessible in nextflow tasks
env {
    TMPDIR = "$SCRATCH"
}

// Define parameters taht will be accessible in nextflow pipeline script
params {
 
    //qiime input parameters
    inmanifest = "/TO_BE_SET/pipeline_indir/q2_manifest"
    inmetadata = "/TO_BE_SET/nexttest/pipeline_indir/q2_metadata"
    //outdir = "/TO_BE_SET/pipeline_outdir/$date-$projectName"
    outdir = "/TO_BE_SET/nexttest/pipeline_outdir/$projectName"

    //First run to determine dada2 parameters
    first_run = false

    //cutadapt parameters 
    cutadapt {
        primerF = "ACGGRAGGCAGCAG"
        primerR = "TACCAGGGTATCTAATCCT"
        errorRate = "0.15"
        overlap = "13"
    }
    //dada2 parameters
    dada2 {
        trim3F = "0"
        trim3R = "0"
        trunclenF = "0"
        trunclenR = "0"
        maxee = "2"
        minqual = "20"
        chimeras = "consensus"
    }
    //taxo parameters
    taxo {
        database = '/home/ref-bioinfo/tools_data/qiime2/DATABASE_silva_99_16S.qza'
        confidence = '0.8'
    }
    // stats parameters
    stats {
        Rstatsscript = "Rscript_qiime2_snakemake.R"
        Rdir = "R"
        data = "R/DATA"
        script = "R/SCRIPT"
        perc_abund_threshold = "5"
        distance = "bray"
        column_sample_replicat = "Replicats"
        exp_var_samples = "Groups_species"
    }
}


// Define process selector for tasks resources
process {
    // Capture exit codes from upstream processes when piping
    shell = ['/usr/bin/env bash', '-euo', 'pipefail']

    // default for all tasks
    cpus = 1
    queue = 'sequentiel'
    memory = '20GB'
    time = '00:20:00'
    //clusterOptions can be used to add some native specification to pbs pro not available in the standard parameters
    clusterOptions = '-M n -S /bin/bash'

    //cutadapt process
    withName : q2_cutadapt {
        cpus = 14
        memory = '50GB'
        queue = 'omp'   
        time = '01:00:00'
    }
    //dada2 process
    withName : q2_dada2 {
        cpus = 14
        memory = '50GB'
        queue = 'omp'   
        time = '05:00:00'
    }
    // taxonomy process
    withName : q2_taxonomy {
        cpus = 14
        memory = '80GB'
        queue = 'omp'
        time = '00:30:00'
    }
    // for all tasks with the label 'omp_28_100g'
/*    withLabel: omp_28_100g {
        cpus = 28
        memory = '100GB'
        queue = 'omp'
    }*/
}

// Define the executor = cluster scheduler
executor {
    name = 'pbspro'
    exitReadTimeout = '10min'
}

// REPORTS :
reports = "${params.outdir}/wf-reports"
// produce a report in html : report.html
report {
    enabled = true
    file = "${reports}/report.html"
}
// create a diagram of tasks
dag {
    enabled = true
    file = "${reports}/dag.svg"
}
// produce a timeline report in html : timeline.html
timeline {
    enabled = true
    file = "${reports}/timeline.html"
}

// enable trace to get a detailed report on each task trace.txt
trace {
    enabled = true
    fields = 'task_id,hash,native_id,process,name,status,exit,cpus,%cpu,disk,memory,%mem,queue,time,realtime'
    file = "${reports}/trace.txt"
    sep = '\t'
}
